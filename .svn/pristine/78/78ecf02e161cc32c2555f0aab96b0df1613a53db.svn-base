import React, { PureComponent, Fragment } from 'react';
import { connect } from 'dva';
import router from 'umi/router';
import {
    Row,
    Col,
    Card,
    Form,
    Input,
    Select,
    Icon,
    Button,
    Modal,
    Upload,
    notification
} from 'antd';
import StandardTable from '@/components/StandardTable';
import DescriptionList from '@/components/DescriptionList';
import PageHeaderWrapper from '@/components/PageHeaderWrapper';
import styles from '../AuthorityControl/UserControl.less';
import imgUrl from '@/global';

const { Description } = DescriptionList;
function getBase64(file) {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = () => resolve(reader.result);
        reader.onerror = error => reject(error);
    });
}
@connect(({ image }) => ({
  image
}))
class PicturesWall extends React.Component {
    state = {
        previewVisible: false,
        previewImage: '',
        fileList: [],
    };

    props = {
      disabled:false
    }

    componentDidMount() {
        const { Picture } = this.props;
        if (Picture && Array.isArray(Picture)) {
            const fileList = Picture.map((item, index) => {
                return ({
                    uid: index,
                    name: 'image.png',
                    status: 'done',
                    url: imgUrl + item,
                    urlImg : item
                })
            })
            this.setState({
                fileList
            })
        } else if (Picture && !Array.isArray(Picture)) {
            this.setState({
                fileList: [{
                    uid: 1,
                    name: 'image.png',
                    status: 'done',
                    url: imgUrl + Picture,
                },]
            })
        }
    }

    handleCancel = () => this.setState({ previewVisible: false });

    handlePreview = async file => {
        if (!file.url && !file.preview) {
            file.preview = await getBase64(file.originFileObj);
        }

        this.setState({
            previewImage: file.url || file.preview,
            previewVisible: true,
        });
    };

    handleChange = ({ fileList }) => {
        const { dispatch, type } = this.props;
        this.setState({
            fileList
        });
        if (type === 'mainPicture') {
            dispatch({
                type: "image/mainPicture",
                payload: fileList
            });
        }
    };

    render() {
        const { previewVisible, previewImage, fileList } = this.state;
        const { type,disabled } = this.props;
        const uploadButton = (
          <div>
            <Icon type="plus" />
            <div className="ant-upload-text">Upload</div>
          </div>
        );
        const token = localStorage.getItem("token");
        return (
          <div className="clearfix">
            <Upload
              action="/lazy-card/sysUser/uploadUserImg"
              listType="picture-card"
              fileList={fileList}
              data={{ type: 'appImg' }}
              onPreview={this.handlePreview}
              onChange={this.handleChange}
              headers={{
                        Authorization: token
                    }}
              disabled={disabled}
            >
              {disabled || (type === 'mainPicture' && fileList.length >= 10) ? null : uploadButton}
            </Upload>
            <Modal maskClosable={false} visible={previewVisible} footer={null} onCancel={this.handleCancel}>
              <img alt="example" style={{ width: '100%' }} src={previewImage} />
            </Modal>
          </div>
        );
    }
}

const FormItem = Form.Item;
const { Option } = Select;
const CreateForm = Form.create()(props => {
    const { modalVisible, form, handleAdd, handleModalVisible } = props;
    const okHandle = () => {
        form.validateFields((err, fieldsValue) => {
            if (err) return;
            handleAdd(fieldsValue,form);
        });
    };


    return (
      <Modal
        maskClosable={false}
        destroyOnClose
        width={820}
        title="添加"
        visible={modalVisible}
        onOk={okHandle}
        onCancel={() => handleModalVisible()}
      >
        <Row>
          <Col span={24} md={24} lg={12}>
            <FormItem labelCol={{ span: 5 }} wrapperCol={{ span: 15 }} label="图片类型">
              {form.getFieldDecorator('imgType', {
                            rules: [{ required: true, message: '请选择分类！' }],
                        })(
                          <Select placeholder="请选择图片类型" style={{ width: '100%' }}>
                            <Option value={0} key={0}>会员海报</Option>
                            <Option value={1} key={1}>代理商海报</Option>
                          </Select>
                        )}
            </FormItem>
          </Col>
        </Row>
        <Row>
          <Col span={24} md={24} lg={12}>
            <FormItem labelCol={{ span: 5 }} wrapperCol={{ span: 15 }} label="图片">
              {/* 改这里 */}
              {/* {form.getFieldDecorator('dsads', {
                            rules: [{ required: true, message: '请选择状态！' }],
                        })( */}
              <PicturesWall type="mainPicture" />
              {/* )} */}
            </FormItem>
          </Col>
        </Row>
      </Modal>
    );
});

@Form.create()
@connect(({ image }) => ({
  image
}))
class UpdateForm extends PureComponent {
    static defaultProps = {
        handleUpdate: () => { },
        handleUpdateModalVisible: () => { },
        values: {},
        // typeList: []
    };

    render() {
        const { updateModalVisible, handleUpdateModalVisible, handleUpdate, values, form } = this.props;
        const okHandle = () => {
            form.validateFields((err, fieldsValue) => {
                if (err) return;
                form.resetFields();
                if (values.id) {
                    handleUpdate(fieldsValue, values.id, values.pic, values.pictures);
                }
            });
        };
        return (
          <Modal
            maskClosable={false}
            width={820}
            destroyOnClose
            title="编辑"
            visible={updateModalVisible}
            onOk={okHandle}
            onCancel={() => handleUpdateModalVisible(false, values)}
            afterClose={() => handleUpdateModalVisible()}
          >
            <Row>
              <Col span={24} md={24} lg={12}>
                <FormItem labelCol={{ span: 5 }} wrapperCol={{ span: 15 }} label="图片类型">
                  {form.getFieldDecorator('imgType', {
                            rules: [{ required: true, message: '请选择分类！' }],
                            initialValue: values.imgType
                        })(
                          <Select placeholder="请选择图片类型" style={{ width: '100%' }}>
                            <Option value="0" key={0}>会员海报</Option>
                            <Option value="1" key={1}>代理商海报</Option>
                          </Select>
                        )}
                </FormItem>
              </Col>
            </Row>
            <Row>
              <Col span={24} md={24} lg={12}>
                <FormItem labelCol={{ span: 5 }} wrapperCol={{ span: 15 }} label="图片">
                  <PicturesWall
                    type="mainPicture"
                    Picture={
                 values.appImageDetailList &&  values.appImageDetailList.map((item,index)=>{
                  return(
                    item.imgUrl
                  )
                })
              }
                  />
                </FormItem>
              </Col>
            </Row>
          </Modal>

        );
    }
}

const getValue = obj =>
    Object.keys(obj)
        .map(key => obj[key])
        .join(',');
/* eslint react/no-multi-comp:0 */
@connect(({  image,loading }) => ({
  image,loading: loading.models.rule,
}))
@Form.create()
class UploadImage extends PureComponent {
    state = {
        modalVisible: false,
        updateModalVisible: false,
        selectedRows: [],
        formValues: {},
        updateFormValues: {},
        currentRecord: [],
        pageSize: 10,
        currentPage: 1
    };

    static defaultProps = {
      image: {
            list: {},
        },
    };

    columns = [
        {
            title: '图片类型',
            dataIndex: 'imgType',
            key: 'imgType',
            render:(data,item)=>{
              return item.imgType === "0" ? "会员海报" : "代理商海报"
            }
        },
       
        {
            title: '操作',
            render: (text, record) => (
              <Fragment>
                <a onClick={() => this.handleUpdateModalVisible(true, record)}>编辑</a>
                <a style={{ marginLeft: "10px" }} onClick={() => this.handleShowModalVisible(true, record)}>查看</a>
                {/* {
                 record.isGrounding == '0' ?  <a style={{ marginLeft: "10px" }} onClick={() => this.handleShowModalVisible(true, record)}>下架</a>
                 :
                 <a style={{ marginLeft: "10px" }} onClick={() => this.handleShowModalVisible(true, record)}>上架</a>
               } */}
              </Fragment>
            ),
        },
    ];

    componentDidMount() {
        const { dispatch } = this.props;
        dispatch({
            type: 'image/fetchImage',
            payload: {
                pageNo: 1,
                pageSize: 10
            }
        });
    }

    handleStandardTableChange = (pagination, filtersArg, sorter) => {
        const { dispatch } = this.props;
        const { formValues, pageSize } = this.state;

        const filters = Object.keys(filtersArg).reduce((obj, key) => {
            const newObj = { ...obj };
            newObj[key] = getValue(filtersArg[key]);
            return newObj;
        }, {});

        const params = {
            pageNo: pagination.current,
            pageSize,
            ...formValues,
            ...filters,
        };
        this.setState({
            currentPage: pagination.current
        });
        dispatch({
            type: 'image/fetchImage',
            payload: params,
        });
    };

    previewItem = id => {
        router.push(`/profile/basic/${id}`);
    };

    handleFormReset = () => {
        const { form, dispatch } = this.props;
        const { pageSize } = this.state;
        form.resetFields();
        this.setState({
            formValues: {},
            currentPage: 1
        });
        dispatch({
            type: 'image/fetchImage',
            payload: {
                pageNo: 1,
                pageSize,
            },
        });
    };


    handleMenuClick = e => {
        const { dispatch } = this.props;
        const { selectedRows } = this.state;
        if (selectedRows.length === 0) return;
        const payload = {
            ids: selectedRows.map(row => row.id),
        };

    };

    handleSelectRows = rows => {
        this.setState({
            selectedRows: rows,
        });
    };

    handleSearch = e => {
        e.preventDefault();
        const { dispatch, form } = this.props;
        const { pageSize } = this.state;

        form.validateFields((err, fieldsValue) => {
            if (err) return;

            const values = {
                ...fieldsValue,
            };

            this.setState({
                currentPage: 1,
                formValues: values,
            });

            dispatch({
                type: 'image/fetchImage',
                payload: {
                    ...values,
                    "pageNo": 1,
                    "pageSize": pageSize,
                }
            });
        });
    };

    handleModalVisible = flag => {
        this.setState({
            modalVisible: !!flag,
        });
    };

    handleUpdateModalVisible = (flag, record) => {
        this.setState({
            updateModalVisible: !!flag,
            updateFormValues: record || {},
        });
    };

    handleShowModalVisible = (flag, record) => {
        this.setState({
            detailModalVisible: !!flag,
            currentRecord: record || {},
        });
    };

    handleAdd = (fields,form) => {
        const { dispatch} = this.props;
        const {image} = this.props;
        const { mainPictureimg } = image;
        const mainPicture = mainPictureimg ? mainPictureimg.map((item) => {
            const path = item.response ? item.response.data.path : '';
            return({
                imgUrl:path,
              })
        }) : '';
        // 判断主图详情图是否存在
        if(mainPicture){
            dispatch({
                type: 'image/add',
                payload: {
                    ...fields,
                    appImageDetailList: mainPicture,
                },
            }).then((res) => {
                if (res.code === "SUCCESS") {
                    form.resetFields();
                    this.handleModalVisible();
                }
            });
        }else{
            notification.error({
                message: "错误",
                description: "请上传商品图片",
              });
        }
        
    };

    handleUpdate = (fields, id, pic, pictures) => {
        const { dispatch, image } = this.props;
        const { mainPictureimg } = image;
        const mainPicture = mainPictureimg ? mainPictureimg.map((item) => {
            const path = item.response ? item.response.data.path : item.urlImg;
            return({
                imgUrl:path,
              })
        }) : '';
        const payload = { id, ...fields,appImageDetailList: mainPicture,};
        dispatch({
            type: 'image/add',
            payload
        });
        this.handleUpdateModalVisible();
    };

    renderForm() {
        const {
            form: { getFieldDecorator },
        } = this.props;
        return (
          <Form onSubmit={this.handleSearch} layout="inline">
            <Row gutter={{ md: 8, lg: 24, xl: 48 }}>
              <Col md={8} sm={24}>
                <FormItem label="商品名">
                  {getFieldDecorator('name')(<Input placeholder="请输入" />)}
                </FormItem>
              </Col>
              <Col md={8} sm={24}>
                <FormItem label="类型">
                  {getFieldDecorator('productCategoryId')(
                    <Select placeholder="请选择" style={{ width: '100%' }} />
                            )}
                </FormItem>
              </Col>
            </Row>
            <Row>
              <Col sm={24}>
                <span className={styles.submitButtons}>
                  <Button type="primary" htmlType="submit">
                                查询
                  </Button>
                  <Button style={{ marginLeft: 8 }} onClick={this.handleFormReset}>
                                重置
                  </Button>
                </span>
              </Col>
            </Row>
          </Form>
        );
    }

    render() {
        const {
          image : {list},
            loading,
        } = this.props;
        const { selectedRows, modalVisible, updateModalVisible, updateFormValues, detailModalVisible, currentRecord, currentPage, pageSize } = this.state;
        const pagination = {
            current: currentPage,
            pageSize,
            total: list.total,
        }

        let imgs =[]
        if(currentRecord.appImageDetailList){

          imgs = currentRecord.appImageDetailList;
        }
        const parentMethods = {
            handleAdd: this.handleAdd,
            handleModalVisible: this.handleModalVisible,
        };
        const updateMethods = {
            handleUpdateModalVisible: this.handleUpdateModalVisible,
            handleUpdate: this.handleUpdate,
        };
        return (
          <PageHeaderWrapper title="海报管理">
            <Card bordered={false}>
              <div className={styles.tableList}>
                {/* <div className={styles.tableListForm}>{this.renderForm()}</div> */}
                <div className={styles.tableListOperator}>
                  <Button icon="plus" type="primary" onClick={() => this.handleModalVisible(true)}>
                                新建
                  </Button>
                </div>
                <StandardTable
                  rowKey='id'
                  rowClassName="textCenter"
                  // selectedRows={selectedRows}
                  loading={loading}
                  data={list.rows}
                  pagination={pagination}
                  columns={this.columns}
                  onSelectRow={this.handleSelectRows}
                  onChange={this.handleStandardTableChange}
                />
              </div>
            </Card>
            <Modal
              maskClosable={false}
              destroyOnClose
              title="查看详情"
              visible={detailModalVisible}
              width={820}
              okText="确定"
              cancelText="取消"
              onCancel={() => this.handleShowModalVisible()}
              onOk={() => this.handleShowModalVisible()}
            >
              {currentRecord &&
                <DescriptionList col={1} layout="horizontal">
                  <Description term="图片类型">{currentRecord.imgType == '0' ? '会员海报':'代理商海报'}</Description>
                  <Description term="图片">
                    {imgs.map(item => { 
                    return(
                      // <img src={imgUrl+item.imgUrl}></img>
                      <PicturesWall type="holdCard" Picture={item.imgUrl} disabled />
                    )
                  })}
                  </Description>
                </DescriptionList>
                
              }
            </Modal>
            <CreateForm {...parentMethods} modalVisible={modalVisible} />
            {updateFormValues && Object.keys(updateFormValues).length ? (
              <UpdateForm
                {...updateMethods}
                updateModalVisible={updateModalVisible}
                values={updateFormValues}
              />
                ): null}
          </PageHeaderWrapper>
        );
    }
}

export default UploadImage;